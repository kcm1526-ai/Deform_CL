# Configuration for Lung Vessel Segmentation with MedNeXt-XL Backbone
# MedNeXt-XL: Extra Large MedNeXt with Full Attention (~400M parameters)
#
# Key Features:
# - 96 base channels (3x MedNeXt-S)
# - [3, 4, 12, 12, 12, 12, 12, 4, 3] block counts
# - SE attention in every block
# - Attention gates at skip connections
# - Self-attention at bottleneck
# - Vessel-specific attention
# - Edge enhancement module
# - Deep supervision
# - Gradient checkpointing for memory efficiency
#
# Target: Dice > 0.88 for lung vessel segmentation

MODEL:
  META_ARCHITECTURE: "ClineDeformModel"
  OUT_CHANNELS: (48,)
  OUT_TASKS: ["features"]
  TASK: ['cline', 'seg']
  PRED_CLASS: 1
  BACKBONE:
    NAME: "build_mednext_xl_backbone"  # MedNeXt-XL backbone
    FREEZE_AT: 0
    PRETRAINED: ""
    FREEZE_BACKBONE: False
  # MedNeXt-XL specific settings
  MEDNEXT_SIZE: "XL"  # Extra Large
  MEDNEXT_KERNEL_SIZE: 7  # Large kernel for better context
  # XL attention options
  USE_ATTENTION_GATES: True  # Attention gates at skip connections
  USE_SELF_ATTENTION: True   # Self-attention at bottleneck
  USE_EDGE_ENHANCEMENT: True # Edge enhancement module
  USE_VESSEL_ATTENTION: True # Vessel-specific attention
  UNETENCODER:
    BASE_CHANNELS: 96  # 3x MedNeXt-S (32 -> 96)
    NUM_LAYERS: 4
    NORM: 'SyncBN'
    DEEP_SUPERVISION: True
    USE_ATTENTION_GATES: True
    USE_SE: True
  DEFORM:
    NUM_STEPS: 4
    NORM: 'SyncBN'
    LOSS_EDGE_WEIGHT: 0.5
    SDF_LOSS_WEIGHT: 0.5
    CHAMFER_LOSS_WEIGHT: 1.5
    ADPTPL: True
    LOWER_THRES: 20
    PTS_NUM: 500
    USE_LOCAL_CHAMFER: True
  # Thin vessel loss with increased importance for XL model
  THIN_VESSEL_LOSS:
    ENABLED: True
    DICE_WEIGHT: 0.25
    CLDICE_WEIGHT: 0.40  # Increased for better vessel continuity
    FOCAL_WEIGHT: 0.15
    BOUNDARY_WEIGHT: 0.10
    MULTISCALE_WEIGHT: 0.10
    CLDICE_ALPHA: 0.6
    FOCAL_GAMMA: 2.5
    DEEP_SUPERVISION_WEIGHT: 0.4  # Increased for deeper model

DATASETS:
  TRAIN: ("VesselSeg",)
  TEST: ("VesselSeg",)
  NUM_FOLDS: 5
  TEST_FOLDS: (0,)
  SPLIT_CSV: ""

DATALOADER:
  NUM_WORKERS: 4

INPUT:
  CROP_SIZE_TRAIN: (128, 128, 128)
  AUGMENTATION:
    ELASTIC_DEFORM: True
    ELASTIC_ALPHA: 80.0
    ELASTIC_SIGMA: 8.0
    INTENSITY_SHIFT: 0.15
    INTENSITY_SCALE: 0.15
    GAMMA_RANGE: (0.7, 1.3)

SOLVER:
  # IMS_PER_BATCH = total batch size across all GPUs
  # Model supports batch size 1 per GPU, so set this to num_gpus
  # For 4 GPUs: IMS_PER_BATCH = 4 (1 per GPU)
  IMS_PER_BATCH: 4
  # Learning rate tuned for large model
  BASE_LR: 4e-4  # Scale LR with batch size (1e-4 * 4)
  WEIGHT_DECAY: 1e-5  # Reduced weight decay
  WARMUP_ITERS: 1000  # More warmup for larger model
  WARMUP_FACTOR: 0.01
  LR_SCHEDULER_NAME: "WarmupCosineLR"
  MAX_ITER: 40000  # More iterations for larger model
  CHECKPOINT_PERIOD: 4000
  CLIP_GRADIENTS:
    ENABLED: True
    CLIP_TYPE: "full_model"
    CLIP_VALUE: 0.5
    NORM_TYPE: 2.0
  BACKBONE_MULTIPLIER: 1.0
  OPTIMIZER: "ADAMW"

TEST:
  EVAL_PERIOD: 4000

OUTPUT_DIR: "./outputs/vessel_mednext_xl"

CUDNN_BENCHMARK: False
